---
title: "CA and MCA of NYCABS dataset"
author: "Katerina Dimitrova, Jose Romero, Sergi Munoz"
date: "March 18, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Required Packages: to be increased over the course
```{r}
rm(list=ls())
requiredPackages <- c("effects","FactoMineR","car", "factoextra","RColorBrewer","ggplot2","missMDA","mvoutlier","dplyr","ggmap","ggthemes","knitr","MVA")
missingPackages <- requiredPackages[!(requiredPackages %in% installed.packages()[,"Package"])]

if(length(missingPackages)) install.packages(missingPackages)
lapply(requiredPackages, require, character.only = TRUE)

# Useful function
calcQ <- function(x) {
  s.x <- summary(x)
  iqr<-s.x[5]-s.x[2]
  list(souti=s.x[2]-3*iqr, mouti=s.x[2]-1.5*iqr, min=s.x[1], q1=s.x[2], q2=s.x[3],        q3=s.x[5], max=s.x[6], mouts=s.x[5]+1.5*iqr, souts=s.x[5]+3*iqr ) }
```

# CA: f.cost (discretization of Total_amount) vs f.hour and f.tt and period ...

```{r}
par(mfrow=c(1,1))
llvout<-which(df$mvout==TRUE);length(llvout)
#llout<-unique(c(llout,llvout))
tt<-table(df[,c("f.cost","period")])
tt
prop.table(tt,1)
prop.table(table(df$period))
prop.table(tt,2)
prop.table(table(df$f.cost))
chisq.test(tt)

res.ca<-CA(tt)
lines(res.ca$row$coord[,1],res.ca$row$coord[,2],lwd=2,col="blue")

names(res.ca)
res.ca$row$contrib[,1:2]
res.ca$row$coord[,1:2]

fviz_eig(res.ca)
summary(res.ca,dig=2)
fviz_ca_biplot(res.ca,repel=TRUE)+theme_bw()

tt<-table(df[,c("f.cost","f.tt")])
tt
prop.table(tt,1)
prop.table(table(df$f.tt))

chisq.test(tt)

### Remark from very previous sessions: how to discretize a numeric variable
fff<-factor(cut(df$traveltime,quantile(df$traveltime),include.lowest = T))
summary(fff)
## End Remark

res.ca<-CA(tt)
lines(res.ca$row$coord[,1],res.ca$row$coord[,2],lwd=2,col="blue")
summary(res.ca)
res.ca$row$contrib[,1:2]
res.ca$row$coord[,1:2]
res.ca$row$cos2[,1:2]
res.ca$eig
sum(res.ca$eig[1:2,1])/sum(res.ca$eig[1:3,1])
sum(res.ca$eig[1:3,1])
res.ca$call$marge.col

fviz_eig(res.ca)
summary(res.ca,dig=2)
fviz_ca_biplot(res.ca,repel=TRUE)+theme_bw()


tt<-table(df[,c("AnyTip","f.tt")])  # No tï¿½ sentit fer-ho
tt
res.ca<-CA(tt)
fviz_ca_biplot(res.ca,repel=TRUE)+theme_bw()

```

# MCA using multivariant

```{r}
par(mfrow=c(1,1))

vars_dis
res.mca<-MCA(df[,c(vars_dis,"Total_amount")],quali.sup=c(5,14),quanti.sup=19)

names(res.mca)
summary(res.mca,nbelements=50)
mean(res.mca$eig$eigenvalue) 

# Individual Representation
plot.MCA(res.mca,choix=c("ind"),cex=0.8)
plot.MCA(res.mca,choix=c("ind"),invisible=c("ind"),cex=0.8)

# Representation of categories
plot.MCA(res.mca,choix=c("ind"),invisible=c("ind"),axes=c(1,2))
lines(res.mca$quali.sup$coord[3:6,1],res.mca$quali.sup$coord[3:6,2],lwd=2,col="darkgreen") # Trencada dels nivells de f.cost
lines(res.mca$quali.sup$coord[1:2,1],res.mca$quali.sup$coord[1:2,2],lwd=2,col="darkblue") # Trencada AnyTip
names(res.mca)
res.mca$var
plot.MCA(res.mca,choix=c("ind"),invisible=c("ind"),axes=c(3,4))
plot.MCA(res.mca,choix=c("var"),axes=c(3,4))

# Use modern ggplot facilities
names(res.mca)
fviz_eig(res.mca)
fviz_cos2(res.mca, choice = "var", axes = 1:2)+theme_bw()
fviz_contrib(res.mca, choice = "var", axes = 3:4)+theme_bw()
fviz_mca_var(res.mca, col.var="contrib",repel=TRUE)+
    scale_color_gradient2(low="green", mid="blue", 
    high="red", midpoint=0.75)+theme_bw()
fviz_mca_var(res.mca, col.var="contrib",repel=F)+
    scale_color_gradient2(low="green", mid="blue", 
    high="red", midpoint=0.75)+theme_bw()

fviz_mca_biplot(res.mca, invisible="ind",axes=1:2,repel=FALSE)+theme_bw()
#fviz_mca_biplot(res.mca, axes=1:2,repel=TRUE,arrows=c(TRUE,FALSE))+theme_bw()
```

# Synthesis through HCPC: Hierarchical Clustering

```{r}
###
### Clustering the individuals
### Before, hou have to perform a PCA with the number of axes 
### that you have decided to take into account (indicated through ncp=)
?HCPC
res.mca<-MCA(df[,c(vars_dis,"Total_amount")],quali.sup=c(5,14),quanti.sup=19,ncp=29)
res.hcpc<-HCPC(res.mca,nb.clust=8,order=TRUE)
names(res.hcpc)

```
